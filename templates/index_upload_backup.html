<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Drive Takeout Consolidator</title>
    
    <!-- HTMX for interactive UI -->
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="/static/style.css">
    
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìÅ</text></svg>">
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <h1>üóÇÔ∏è Google Drive Takeout Consolidator</h1>
            <p class="subtitle">Restore your Google Drive folder structure from takeout zip files</p>
        </header>

        <!-- Step 1: Upload Zip Files -->
        <section class="step" id="step-upload">
            <div class="step-header">
                <span class="step-number">1</span>
                <h2>Upload Takeout Zip Files</h2>
            </div>
            
            <div class="upload-area" id="drop-zone">
                <div class="upload-content">
                    <div class="upload-icon">üìÅ</div>
                    <p class="upload-text">Drag and drop your Google Takeout zip files here</p>
                    <p class="upload-subtext">or click to browse</p>
                    <input type="file" id="file-input" multiple accept=".zip" style="display: none;">
                    <button type="button" class="btn btn-primary" onclick="document.getElementById('file-input').click()">
                        Browse Files
                    </button>
                </div>
            </div>
            
            <div id="upload-status" class="status-area" style="display: none;">
                <div class="spinner" id="upload-spinner"></div>
                <p id="upload-message">Uploading files...</p>
            </div>
        </section>

        <!-- Step 2: Configure Output -->
        <section class="step" id="step-config" style="display: none;">
            <div class="step-header">
                <span class="step-number">2</span>
                <h2>Configure Output Location</h2>
            </div>
            
            <form id="config-form" class="form">
                <div class="form-group">
                    <label for="output-dir">Output Directory:</label>
                    <input type="text" id="output-dir" name="output_dir" 
                           placeholder="/path/to/organized/google/drive" 
                           class="form-input" required>
                    <small class="form-help">Where to save your organized Google Drive files</small>
                </div>
                
                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="verify-files" name="verify" class="checkbox">
                        <span class="checkmark"></span>
                        Verify file integrity (slower but safer)
                    </label>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="resetToUpload()">
                        ‚Üê Back to Upload
                    </button>
                    <button type="submit" class="btn btn-primary">
                        Start Processing
                    </button>
                </div>
            </form>
        </section>

        <!-- Step 3: Processing Progress -->
        <section class="step" id="step-progress" style="display: none;">
            <div class="step-header">
                <span class="step-number">3</span>
                <h2>Processing Files</h2>
            </div>
            
            <div class="progress-container">
                <!-- Current Operation -->
                <div class="current-operation">
                    <h3 id="current-operation-title">Extracting zip files...</h3>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
                    </div>
                    <p class="progress-text">
                        <span id="progress-percent">0%</span> - 
                        <span id="current-file">Starting...</span>
                    </p>
                </div>
                
                <!-- Statistics -->
                <div class="stats-grid" id="stats-grid" style="display: none;">
                    <div class="stat-card">
                        <div class="stat-number" id="stat-total-files">0</div>
                        <div class="stat-label">Total Files</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="stat-processed">0</div>
                        <div class="stat-label">Processed</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="stat-duplicates">0</div>
                        <div class="stat-label">Duplicates Skipped</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="stat-errors">0</div>
                        <div class="stat-label">Errors</div>
                    </div>
                </div>
                
                <!-- Live Log -->
                <div class="log-container">
                    <h4>Live Progress Log</h4>
                    <div class="log-area" id="log-area">
                        <div class="log-entry">
                            <span class="log-time">Starting...</span>
                            <span class="log-message">Initializing process</span>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Step 4: Completion -->
        <section class="step" id="step-complete" style="display: none;">
            <div class="step-header">
                <span class="step-number">‚úì</span>
                <h2>Processing Complete!</h2>
            </div>
            
            <div class="completion-content">
                <div class="success-icon">üéâ</div>
                <h3>Your Google Drive has been successfully organized!</h3>
                
                <div class="final-stats" id="final-stats">
                    <!-- Final statistics will be populated here -->
                </div>
                
                <div class="completion-actions">
                    <button type="button" class="btn btn-primary" onclick="openOutputFolder()">
                        üìÅ Open Output Folder
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="downloadLogs()">
                        üìã Download Logs
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="startOver()">
                        üîÑ Process More Files
                    </button>
                </div>
            </div>
        </section>

        <!-- Error Display -->
        <div class="error-alert" id="error-alert" style="display: none;">
            <div class="error-content">
                <span class="error-icon">‚ö†Ô∏è</span>
                <div class="error-details">
                    <h4>Error Occurred</h4>
                    <p id="error-message">Something went wrong</p>
                </div>
                <button type="button" class="error-close" onclick="hideError()">√ó</button>
            </div>
        </div>
    </div>

    <!-- JavaScript for UI interactions -->
    <script>
        // Global state
        let currentOperationId = null;
        let progressInterval = null;
        let currentStep = 1;
        
        // File upload handling
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');
        
        // Drag and drop events
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('drag-over');
        });
        
        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('drag-over');
        });
        
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('drag-over');
            const files = Array.from(e.dataTransfer.files).filter(f => f.name.endsWith('.zip'));
            if (files.length > 0) {
                uploadFiles(files);
            } else {
                showError('Please drop only .zip files');
            }
        });
        
        // File input change
        fileInput.addEventListener('change', (e) => {
            const files = Array.from(e.target.files);
            if (files.length > 0) {
                uploadFiles(files);
            }
        });
        
        // Upload files to server
        async function uploadFiles(files) {
            showUploadStatus(true);
            updateUploadMessage(`Uploading ${files.length} files...`);
            
            const formData = new FormData();
            files.forEach(file => formData.append('files', file));
            
            try {
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    currentOperationId = result.operation_id;
                    updateUploadMessage(`Uploaded ${result.uploaded_files.length} files successfully`);
                    
                    // Auto-extract and move to config
                    setTimeout(() => {
                        extractFiles(result.temp_dir);
                    }, 1000);
                } else {
                    throw new Error(result.message || 'Upload failed');
                }
            } catch (error) {
                showError(`Upload failed: ${error.message}`);
                showUploadStatus(false);
            }
        }
        
        // Extract uploaded files
        async function extractFiles(tempDir) {
            updateUploadMessage('Extracting zip files...');
            
            const formData = new FormData();
            formData.append('operation_id', currentOperationId);
            formData.append('temp_dir', tempDir);
            formData.append('output_dir', getDefaultOutputDir());
            
            try {
                const response = await fetch('/extract', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Start monitoring extraction progress
                    startProgressMonitoring();
                    
                    // Move to config step after a delay
                    setTimeout(() => {
                        showStep(2);
                        showUploadStatus(false);
                        populateDefaultOutputDir();
                    }, 2000);
                } else {
                    throw new Error(result.message || 'Extraction failed');
                }
            } catch (error) {
                showError(`Extraction failed: ${error.message}`);
                showUploadStatus(false);
            }
        }
        
        // Configuration form submission
        document.getElementById('config-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const outputDir = document.getElementById('output-dir').value;
            const verify = document.getElementById('verify-files').checked;
            
            if (!outputDir.trim()) {
                showError('Please specify an output directory');
                return;
            }
            
            // Start consolidation
            await startConsolidation(outputDir, verify);
        });
        
        // Start consolidation process
        async function startConsolidation(outputDir, verify) {
            showStep(3);
            updateOperationTitle('Starting consolidation...');
            
            const formData = new FormData();
            formData.append('operation_id', currentOperationId);
            formData.append('source_dir', getDefaultOutputDir() + '/extracted_takeouts');
            formData.append('dest_dir', outputDir);
            formData.append('verify', verify);
            
            try {
                const response = await fetch('/consolidate', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    startProgressMonitoring();
                } else {
                    throw new Error(result.message || 'Consolidation failed to start');
                }
            } catch (error) {
                showError(`Failed to start consolidation: ${error.message}`);
            }
        }
        
        // Progress monitoring
        function startProgressMonitoring() {
            if (progressInterval) clearInterval(progressInterval);
            
            progressInterval = setInterval(async () => {
                try {
                    const response = await fetch(`/progress/${currentOperationId}`);
                    const data = await response.json();
                    
                    updateProgress(data);
                    
                    // Check if operation is complete
                    if (data.operation.status === 'consolidation_complete') {
                        clearInterval(progressInterval);
                        showCompletion(data.operation);
                    } else if (data.operation.status.includes('failed') || data.operation.status === 'error') {
                        clearInterval(progressInterval);
                        showError(`Operation failed: ${data.operation.message}`);
                    }
                } catch (error) {
                    console.error('Error fetching progress:', error);
                }
            }, 1000); // Update every second
        }
        
        // Update progress display
        function updateProgress(data) {
            const operation = data.operation;
            const logs = data.recent_logs;
            
            // Update title based on status
            if (operation.status === 'extraction_complete') {
                updateOperationTitle('Organizing files...');
            } else if (operation.status === 'consolidating') {
                updateOperationTitle('Consolidating Google Drive structure...');
                document.getElementById('stats-grid').style.display = 'grid';
            }
            
            // Update progress bar
            const progressFill = document.getElementById('progress-fill');
            const progressPercent = document.getElementById('progress-percent');
            const currentFile = document.getElementById('current-file');
            
            const progress = operation.progress || 0;
            progressFill.style.width = `${progress}%`;
            progressPercent.textContent = `${progress.toFixed(1)}%`;
            currentFile.textContent = operation.current_file || 'Processing...';
            
            // Update statistics if available
            if (operation.stats) {
                updateStats(operation.stats);
            }
            
            // Update log
            updateLog(logs);
        }
        
        // Update statistics display
        function updateStats(stats) {
            document.getElementById('stat-total-files').textContent = stats.total_files?.toLocaleString() || '0';
            document.getElementById('stat-processed').textContent = stats.copied_files?.toLocaleString() || '0';
            document.getElementById('stat-duplicates').textContent = stats.skipped_duplicates?.toLocaleString() || '0';
            document.getElementById('stat-errors').textContent = stats.errors?.toLocaleString() || '0';
        }
        
        // Update log display
        function updateLog(logs) {
            const logArea = document.getElementById('log-area');
            
            logs.forEach(log => {
                const logEntry = document.createElement('div');
                logEntry.className = 'log-entry';
                logEntry.innerHTML = `
                    <span class="log-time">${new Date(log.timestamp).toLocaleTimeString()}</span>
                    <span class="log-message">${log.message}</span>
                `;
                logArea.appendChild(logEntry);
            });
            
            // Keep only last 50 entries
            while (logArea.children.length > 50) {
                logArea.removeChild(logArea.firstChild);
            }
            
            // Auto-scroll to bottom
            logArea.scrollTop = logArea.scrollHeight;
        }
        
        // Show completion
        function showCompletion(operation) {
            showStep(4);
            
            const finalStats = operation.final_stats || {};
            const statsHtml = `
                <div class="final-stats-grid">
                    <div class="final-stat">
                        <strong>${(finalStats.total_files || 0).toLocaleString()}</strong>
                        <span>Total files processed</span>
                    </div>
                    <div class="final-stat">
                        <strong>${(finalStats.copied_files || 0).toLocaleString()}</strong>
                        <span>Files organized</span>
                    </div>
                    <div class="final-stat">
                        <strong>${((finalStats.copied_size || 0) / (1024**3)).toFixed(2)} GB</strong>
                        <span>Data processed</span>
                    </div>
                    <div class="final-stat">
                        <strong>${(finalStats.skipped_duplicates || 0).toLocaleString()}</strong>
                        <span>Duplicates removed</span>
                    </div>
                </div>
            `;
            
            document.getElementById('final-stats').innerHTML = statsHtml;
        }
        
        // Utility functions
        function showStep(stepNumber) {
            document.querySelectorAll('.step').forEach(step => step.style.display = 'none');
            document.getElementById(`step-${['upload', 'config', 'progress', 'complete'][stepNumber - 1]}`).style.display = 'block';
            currentStep = stepNumber;
        }
        
        function showUploadStatus(show) {
            document.getElementById('upload-status').style.display = show ? 'block' : 'none';
        }
        
        function updateUploadMessage(message) {
            document.getElementById('upload-message').textContent = message;
        }
        
        function updateOperationTitle(title) {
            document.getElementById('current-operation-title').textContent = title;
        }
        
        function showError(message) {
            document.getElementById('error-message').textContent = message;
            document.getElementById('error-alert').style.display = 'block';
        }
        
        function hideError() {
            document.getElementById('error-alert').style.display = 'none';
        }
        
        function getDefaultOutputDir() {
            // Try to detect OS and suggest appropriate directory
            const platform = navigator.platform.toLowerCase();
            if (platform.includes('mac')) {
                return '/Users/' + (navigator.userAgent.includes('Chrome') ? 'your-username' : 'your-username') + '/Desktop/Google Drive Organized';
            } else if (platform.includes('win')) {
                return 'C:\\Users\\your-username\\Desktop\\Google Drive Organized';
            } else {
                return '/home/your-username/Desktop/Google Drive Organized';
            }
        }
        
        function populateDefaultOutputDir() {
            document.getElementById('output-dir').value = getDefaultOutputDir();
        }
        
        function resetToUpload() {
            showStep(1);
            if (progressInterval) clearInterval(progressInterval);
        }
        
        function startOver() {
            currentOperationId = null;
            showStep(1);
            if (progressInterval) clearInterval(progressInterval);
            
            // Reset form
            document.getElementById('file-input').value = '';
            document.getElementById('output-dir').value = '';
            document.getElementById('verify-files').checked = false;
        }
        
        function openOutputFolder() {
            const outputDir = document.getElementById('output-dir').value;
            // This will only work in some browsers and contexts
            if (window.showDirectoryPicker) {
                window.showDirectoryPicker();
            } else {
                alert(`Your organized files are at: ${outputDir}`);
            }
        }
        
        function downloadLogs() {
            if (currentOperationId) {
                window.open(`/logs/${currentOperationId}`, '_blank');
            }
        }
    </script>
</body>
</html>
