<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Drive Takeout Consolidator</title>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="app">
        <header class="app-header">
            <h1>Google Drive Takeout Consolidator</h1>
            <p>Restore your Google Drive folder structure from takeout zip files</p>
        </header>

        <main class="app-main">
            <!-- Main Interface -->
            <div class="interface" id="main-interface">
                <div class="panel-grid">
                    <!-- Left Panel: File Selection -->
                    <div class="panel">
                        <div class="panel-header">
                            <h2>Select Source Folder</h2>
                            <p class="panel-description">Choose the folder containing your Google Takeout ZIP files</p>
                        </div>
                        
                        <div class="drop-zone" id="drop-zone">
                            <div class="drop-content">
                                <span class="drop-icon">üìÅ</span>
                                <p>Drop any file here to detect folder path</p>
                                <small>No uploading - just path detection</small>
                            </div>
                        </div>
                        
                        <div class="file-actions">
                            <input type="text" id="folder-path" class="path-input" 
                                   placeholder="Or enter folder path manually" 
                                   onchange="validatePath()">
                            <button type="button" class="btn" onclick="selectFolder()">
                                Browse Folder...
                            </button>
                        </div>
                        
                        <!-- Found ZIP files list -->
                        <div class="file-list" id="file-list" style="display: none;">
                            <h3>üìÅ Found ZIP Files</h3>
                            <div class="zip-list" id="zip-list">
                                <!-- ZIP files will be populated here -->
                            </div>
                        </div>
                    </div>

                    <!-- Right Panel: Settings -->
                    <div class="panel">
                        <div class="panel-header">
                            <h2>Configure Output Settings</h2>
                            <p class="panel-description">Set how files should be organized and where to save them</p>
                        </div>
                        
                        <div class="settings-form">
                            <label class="checkbox-row">
                                <input type="checkbox" id="dry-run" checked>
                                <span class="checkbox-label">Dry Run (Preview Only)</span>
                            </label>
                            
                            <div class="setting-group">
                                <h3>‚ñ∏ Extract to Temp Folder</h3>
                                <h3>‚ñ∏ Rebuild Folder Hierarchy</h3>
                                <h3>‚ñ∏ Handle File Conflicts:</h3>
                                
                                <div class="conflict-options">
                                    <label class="checkbox-row">
                                        <input type="radio" name="conflict" value="skip" checked>
                                        <span class="checkbox-label">Skip duplicates</span>
                                    </label>
                                    <label class="checkbox-row">
                                        <input type="radio" name="conflict" value="rename">
                                        <span class="checkbox-label">Rename (auto-suffix)</span>
                                    </label>
                                </div>
                            </div>
                            
                            <div class="output-section">
                                <label for="output-folder">üì§ Output Folder:</label>
                                <div class="folder-selector">
                                    <input type="text" id="output-folder" class="path-input" 
                                           placeholder="Choose output folder">
                                    <button type="button" class="btn-small" onclick="chooseOutputFolder()">
                                        Choose...
                                    </button>
                                </div>
                            </div>
                            
                            <button type="button" class="btn-primary" id="start-btn" 
                                    onclick="startProcessing()" disabled>
                                Start Rebuilding
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Progress Interface -->
            <div class="interface" id="progress-interface" style="display: none;">
                <div class="progress-panel">
                    <div class="panel-header">
                        <h2>Processing Files</h2>
                        <button type="button" class="btn-small" onclick="showLogs()">
                            View Logs
                        </button>
                    </div>
                    
                    <div class="progress-section">
                        <div class="current-operation" id="current-operation">
                            Initializing...
                        </div>
                        
                        <div class="progress-bar">
                            <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
                        </div>
                        
                        <div class="progress-stats">
                            <span id="progress-text">0% - Starting...</span>
                            <span id="operation-status">Ready</span>
                        </div>
                    </div>
                    
                    <div class="stats-grid" id="stats-display" style="display: none;">
                        <div class="stat">
                            <div class="stat-value" id="total-files">0</div>
                            <div class="stat-label">Total Files</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value" id="processed-files">0</div>
                            <div class="stat-label">Processed</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value" id="skipped-files">0</div>
                            <div class="stat-label">Skipped</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value" id="error-count">0</div>
                            <div class="stat-label">Errors</div>
                        </div>
                    </div>
                    
                    <div class="action-buttons">
                        <button type="button" class="btn" onclick="cancelOperation()">
                            Cancel
                        </button>
                        <button type="button" class="btn" onclick="showMainInterface()">
                            ‚Üê Back
                        </button>
                    </div>
                </div>
            </div>

            <!-- Completion Interface -->
            <div class="interface" id="completion-interface" style="display: none;">
                <div class="completion-panel">
                    <div class="panel-header">
                        <h2>‚úÖ Processing Complete</h2>
                    </div>
                    
                    <div class="completion-summary" id="completion-summary">
                        <!-- Results will be populated here -->
                    </div>
                    
                    <div class="action-buttons">
                        <button type="button" class="btn-primary" onclick="openOutputFolder()">
                            Open Output Folder
                        </button>
                        <button type="button" class="btn" onclick="downloadLogs()">
                            Download Logs
                        </button>
                        <button type="button" class="btn" onclick="startOver()">
                            Process More Files
                        </button>
                    </div>
                </div>
            </div>
        </main>

        <!-- Error Toast -->
        <div class="toast error-toast" id="error-toast" style="display: none;">
            <span id="error-message">Error message</span>
            <button type="button" onclick="hideError()">√ó</button>
        </div>
    </div>

    <script>
        // Global state
        let currentOperation = null;
        let progressInterval = null;
        let foundZips = [];

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            setupDropZone();
            populateDefaultOutputPath();
        });

        // Drop zone setup for path detection (NO file upload)
        function setupDropZone() {
            const dropZone = document.getElementById('drop-zone');
            
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('drag-over');
            });
            
            dropZone.addEventListener('dragleave', () => {
                dropZone.classList.remove('drag-over');
            });
            
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('drag-over');
                
                // Get folder path from dropped file
                const items = e.dataTransfer.items;
                if (items && items.length > 0) {
                    const item = items[0];
                    if (item.kind === 'file') {
                        const file = item.getAsFile();
                        // Extract directory path from file
                        let folderPath = '';
                        
                        if (file.webkitRelativePath) {
                            // If from folder selection, get parent folder
                            const pathParts = file.webkitRelativePath.split('/');
                            pathParts.pop(); // Remove filename
                            folderPath = pathParts.join('/');
                        } else {
                            // Single file - user needs to specify folder manually
                            folderPath = prompt('Enter the folder path containing your ZIP files:', '');
                        }
                        
                        if (folderPath) {
                            document.getElementById('folder-path').value = folderPath;
                            validatePath();
                        }
                    }
                }
            });
        }

        // Browse for folder (web browser limitations - will prompt for path)
        function selectFolder() {
            const currentPath = document.getElementById('folder-path').value;
            const folderPath = prompt('Enter the path to your folder containing ZIP files:', currentPath || '');
            
            if (folderPath) {
                document.getElementById('folder-path').value = folderPath;
                validatePath();
            }
        }

        // Validate path and find ZIP files
        async function validatePath() {
            const path = document.getElementById('folder-path').value.trim();
            if (!path) {
                foundZips = [];
                displayFoundZips();
                updateStartButton();
                return;
            }

            try {
                const response = await fetch('/validate-path', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ path: path })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    foundZips = result.zip_files;
                    displayFoundZips();
                    updateStartButton();
                    showSuccess(`Found ${foundZips.length} ZIP files`);
                } else {
                    foundZips = [];
                    displayFoundZips();
                    updateStartButton();
                    showError(result.message || 'Invalid path');
                }
            } catch (error) {
                foundZips = [];
                displayFoundZips();
                updateStartButton();
                showError(`Error validating path: ${error.message}`);
            }
        }

        // Display found ZIP files
        function displayFoundZips() {
            const fileList = document.getElementById('file-list');
            const zipList = document.getElementById('zip-list');
            
            if (foundZips.length === 0) {
                fileList.style.display = 'none';
                return;
            }
            
            zipList.innerHTML = foundZips.map(zip => `
                <div class="zip-item">
                    <span class="zip-name">${zip.name}</span>
                    <span class="zip-size">${formatSize(zip.size || 0)}</span>
                </div>
            `).join('');
            
            fileList.style.display = 'block';
        }

        // Update start button state
        function updateStartButton() {
            const startBtn = document.getElementById('start-btn');
            const folderPath = document.getElementById('folder-path').value.trim();
            const outputPath = document.getElementById('output-folder').value.trim();
            
            startBtn.disabled = !(foundZips.length > 0 && outputPath);
        }

        // Choose output folder
        function chooseOutputFolder() {
            const currentPath = document.getElementById('output-folder').value;
            const newPath = prompt('Enter output folder path:', currentPath || getDefaultOutputPath());
            
            if (newPath) {
                document.getElementById('output-folder').value = newPath;
                updateStartButton();
            }
        }

        // Start processing with local paths (NO UPLOADS)
        async function startProcessing() {
            const folderPath = document.getElementById('folder-path').value.trim();
            const outputPath = document.getElementById('output-folder').value.trim();
            const isDryRun = document.getElementById('dry-run').checked;
            const conflictMode = document.querySelector('input[name="conflict"]:checked').value;

            if (!folderPath || !outputPath) {
                showError('Please specify both source and output folders');
                return;
            }

            try {
                const response = await fetch('/start-processing', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        source_path: folderPath,
                        output_path: outputPath,
                        dry_run: isDryRun,
                        verify: false // Can be made configurable
                    })
                });

                const result = await response.json();

                if (result.success) {
                    currentOperation = result.operation_id;
                    showProgressInterface();
                    startProgressMonitoring();
                } else {
                    showError(result.message || 'Failed to start processing');
                }
            } catch (error) {
                showError(`Error starting processing: ${error.message}`);
            }
        }

        // Progress monitoring
        function startProgressMonitoring() {
            if (progressInterval) clearInterval(progressInterval);
            
            progressInterval = setInterval(async () => {
                if (!currentOperation) return;
                
                try {
                    const response = await fetch(`/progress/${currentOperation}`);
                    const data = await response.json();
                    
                    updateProgress(data.operation);
                    
                    if (data.operation.status === 'completed') {
                        clearInterval(progressInterval);
                        showCompletionInterface(data.operation);
                    } else if (data.operation.status === 'failed') {
                        clearInterval(progressInterval);
                        showError(data.operation.message || 'Processing failed');
                        showMainInterface();
                    }
                } catch (error) {
                    console.error('Error fetching progress:', error);
                }
            }, 2000); // Update every 2 seconds (not too frequent)
        }

        // Update progress display
        function updateProgress(operation) {
            document.getElementById('current-operation').textContent = operation.current_operation || 'Processing...';
            document.getElementById('progress-fill').style.width = `${operation.progress_percent || 0}%`;
            document.getElementById('progress-text').textContent = `${(operation.progress_percent || 0).toFixed(1)}% - ${operation.current_file || 'Working...'}`;
            document.getElementById('operation-status').textContent = operation.status || 'Running';
            
            if (operation.stats) {
                document.getElementById('stats-display').style.display = 'grid';
                document.getElementById('total-files').textContent = (operation.stats.total_files || 0).toLocaleString();
                document.getElementById('processed-files').textContent = (operation.stats.copied_files || 0).toLocaleString();
                document.getElementById('skipped-files').textContent = (operation.stats.skipped_duplicates || 0).toLocaleString();
                document.getElementById('error-count').textContent = (operation.stats.errors || 0).toLocaleString();
            }
        }

        // Interface switching
        function showMainInterface() {
            document.getElementById('main-interface').style.display = 'block';
            document.getElementById('progress-interface').style.display = 'none';
            document.getElementById('completion-interface').style.display = 'none';
        }

        function showProgressInterface() {
            document.getElementById('main-interface').style.display = 'none';
            document.getElementById('progress-interface').style.display = 'block';
            document.getElementById('completion-interface').style.display = 'none';
        }

        function showCompletionInterface(operation) {
            document.getElementById('main-interface').style.display = 'none';
            document.getElementById('progress-interface').style.display = 'none';
            document.getElementById('completion-interface').style.display = 'block';
            
            // Populate completion summary
            const summary = document.getElementById('completion-summary');
            const stats = operation.final_stats || {};
            summary.innerHTML = `
                <div class="completion-stats">
                    <div class="stat">
                        <div class="stat-value">${(stats.total_files || 0).toLocaleString()}</div>
                        <div class="stat-label">Files Processed</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value">${(stats.copied_files || 0).toLocaleString()}</div>
                        <div class="stat-label">Files Organized</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value">${((stats.copied_size || 0) / (1024**3)).toFixed(2)} GB</div>
                        <div class="stat-label">Data Processed</div>
                    </div>
                </div>
                <p>Your Google Drive has been successfully organized!</p>
            `;
        }

        // Utility functions
        function populateDefaultOutputPath() {
            const platform = navigator.platform.toLowerCase();
            let defaultPath;
            
            if (platform.includes('mac')) {
                defaultPath = '/Users/' + (process.env.USER || 'your-username') + '/Desktop/Google Drive Organized';
            } else if (platform.includes('win')) {
                defaultPath = 'C:\\Users\\your-username\\Desktop\\Google Drive Organized';
            } else {
                defaultPath = '/home/your-username/Desktop/Google Drive Organized';
            }
            
            document.getElementById('output-folder').value = defaultPath;
            updateStartButton();
        }

        function getDefaultOutputPath() {
            return document.getElementById('output-folder').value;
        }

        function formatSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }

        function showError(message) {
            document.getElementById('error-message').textContent = message;
            document.getElementById('error-toast').style.display = 'block';
            setTimeout(() => hideError(), 5000);
        }

        function showSuccess(message) {
            // Could add success toast, for now just console
            console.log('Success:', message);
        }

        function hideError() {
            document.getElementById('error-toast').style.display = 'none';
        }

        function showLogs() {
            if (currentOperation) {
                window.open(`/logs/${currentOperation}`, '_blank');
            }
        }

        function cancelOperation() {
            if (currentOperation && confirm('Cancel current operation?')) {
                fetch(`/cancel/${currentOperation}`, { method: 'POST' });
                clearInterval(progressInterval);
                showMainInterface();
            }
        }

        function openOutputFolder() {
            const outputPath = document.getElementById('output-folder').value;
            alert(`Your organized files are at: ${outputPath}`);
        }

        function downloadLogs() {
            if (currentOperation) {
                window.open(`/logs/${currentOperation}?download=true`, '_blank');
            }
        }

        function startOver() {
            currentOperation = null;
            foundZips = [];
            document.getElementById('folder-path').value = '';
            document.getElementById('dry-run').checked = true;
            displayFoundZips();
            updateStartButton();
            showMainInterface();
        }

        // Auto-update when paths change
        document.getElementById('folder-path').addEventListener('input', updateStartButton);
        document.getElementById('output-folder').addEventListener('input', updateStartButton);
    </script>
</body>
</html>